<script>
    function generateLink() {
        const input = document.getElementById('dropboxLink').value.trim();
        const resultArea = document.getElementById('resultArea');
        const finalLinkBox = document.getElementById('finalLink');
        const embedCodeBox = document.getElementById('embedCode');

        if (!input) { alert("Please paste a link first!"); return; }

        // --- CONFIGURATION ---
        const viewerUrl = "https://crawby.github.io/pdf-reader/web/viewer.html";
        const workerUrl = "https://dropbox-guard.ccrawford.workers.dev/";
        // ---------------------

        let base64Link;
        try { base64Link = btoa(input); } 
        catch (e) { alert("Error encoding link."); return; }

        // Create Master URL (Simple version, no &ref= needed)
        const finalUrl = `${viewerUrl}?file=${workerUrl}?file=${base64Link}`;

        // Create Embed HTML
        // Note: referrerpolicy="origin" is CRITICAL for the Bouncer to work
        const embedHtml = `<!-- Mobile Friendly Link -->
<div style="text-align: right; margin-bottom: 8px;">
    <a href="${finalUrl}" 
       target="_blank" 
       referrerpolicy="origin" 
       style="text-decoration: none; color: #333; font-family: sans-serif; font-size: 0.9em; border: 1px solid #ccc; padding: 5px 10px; border-radius: 4px; background-color: #f9f9f9;">
        <span style="font-size: 1.1em; margin-right: 4px;">&#x2197;</span> Open Full Screen
    </a>
</div>

<!-- The PDF Reader -->
<iframe 
    src="${finalUrl}" 
    width="100%" 
    height="900" 
    style="border: 1px solid #ccc; border-radius: 4px;" 
    referrerpolicy="origin"
    allowfullscreen 
    webkitallowfullscreen 
    mozallowfullscreen>
</iframe>`;

        finalLinkBox.textContent = finalUrl;
        embedCodeBox.textContent = embedHtml;
        resultArea.style.display = "block";
    }
    // ... (Keep copyToClipboard and clearField functions) ...
</script>
